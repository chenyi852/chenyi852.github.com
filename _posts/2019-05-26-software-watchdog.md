Software watchdog

顾名思义，Software watchdog 就是通过软件实现的watchdog。具体的做法是： 启动后台进程定期touch更新时戳。同时在时钟中断中或NMI(不可屏蔽中断)检测是否后台进程定期更新时戳量，如果在规定的*时间阈值*内没有更新，则说明此后台进程没有调度，系统出现异常。如果有更新，则说明至少watchdog进程有调度。

那么什么情况会导致后台进程没有调度呢？可能的原因如下：

- 硬件出现异常，导致CPU停止运行。

- CPU进入异常状态，已经无法响应中断

- 系统关中断

- 系统关抢占

- 中断太频繁，导致后台进程得不到运行

- CPU被其他进程一直霸占导致该进程得不到运行，具体原因和系统的调度算法相关。

  

Q&A

- 后台进程的优先级如何设置？

  具体得看你watchdog想要监控的对象， 

  - 如果你只想看系统有无调度，是否关中断，那么把后台进程设置成为优先级最高的进程。
  - 如果你希望保证系统所有的进程都能在指定时间内调度，那么把后台进程设置成为优先级最低的进程。
  
- 时间阈值设置成多少？

  至少要保证时钟中断检测出异常后，硬件watchdog不会复位系统，如果有硬件watchdog的话。

- 需要抓取的信息？

  - 系统是否已经关中断，关中断的进程及调用栈（如果是在NMI中检测是可以在关中断的情况下检测，如果只是在时钟中断中检测是不可以在关中断的情况下检测的，因为关中断的情况下，时钟中断也不可响应）
  - 系统是否已经关调度，关调度的进程及调用栈
  - 中断来的频率，可以在每次中断来时刷新中断次数计数， 每秒清零一次，并更新时戳。（这样可以统计出距离上次清0过了多长时间）
  - 被打断的CPU进程及运行时间。占用CPU时间最长的进程。
  
  